/*!
Name: Open Weather
Dependencies: jQuery, OpenWeatherMap API
Author: Michael Lynch
Author URL: http://michaelynch.com
Date Created: August 28, 2013
Date Modified: February 12, 2016
Modified by: blinksmith
Licensed under the MIT license
*/
;(function($) {
  $.fn.openWeather = function(response) {
    if (!this.length) {
      return this;
    }
    $(this);
    this.settings = {};
    var elTarget = this.settings = $.extend({}, {
	 iconTarget:null,
	 customIcons:null,
	 lat:null, lng:null,
	 city:null, key:null,
	 lang:"en",
	 kFlickr:null,
	 k500px:null,
	success:function() {
    }, error:function($) {
    }}, response);
    response = "//api.openweathermap.org/data/2.5/weather?lang=" + elTarget.lang;
    null != elTarget.lat && null != elTarget.lng ? response += "&lat=" + elTarget.lat + "&lon=" + elTarget.lng : null != elTarget.city && (response += "&q=" + elTarget.city.replace(" ", ""));
    null != elTarget.key && (response += "&appid=" + elTarget.key);
    var formatTime = function($) {
      var elTarget = new Date(1E3 * $);
      $ = elTarget.getHours();
      12 < $ && (hoursRemaining = 24 - $, $ = 12 - hoursRemaining);
      elTarget = elTarget.getMinutes();
      elTarget = elTarget.toString();
      2 > elTarget.length && (elTarget = 0 + elTarget);
      return $ + ":" + elTarget;
    };
    $.ajax({type:"GET", url:response, dataType:"jsonp", success:function(response) {
      var r = response.weather[0].description;
      null != elTarget.k500px && "use500px" == elTarget.backgroundImage ? $.getJSON("https://api.500px.com/v1/photos/search?consumer_key=" + elTarget.k500px + "&term=" + r + "&feature=popular&image_size=1080&only=8&rpp=10", function(elTarget) {
        elTarget = elTarget.photos[Math.floor(Math.random() * elTarget.photos.length)].images[0].url;
        $("html").css("background", "url(" + elTarget + ") no-repeat center center fixed");
        $("html").css("background-size", "cover");
      }) : null != elTarget.kFlickr && "useFlickr" == elTarget.backgroundImage && $.getJSON("https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=" + elTarget.kFlickr + "&text=" + r + "&format=json&jsoncallback=?&media=photos&per_page=10", function(elTarget) {
        elTarget = elTarget.photos.photo[Math.floor(Math.random() * elTarget.photos.photo.length)];
        elTarget = "https://farm" + elTarget.farm + ".staticflickr.com/" + elTarget.server + "/" + elTarget.id + "_" + elTarget.secret + "_b.jpg";
        $("html").css("background", "url(" + elTarget + ") no-repeat center center fixed");
        $("html").css("background-size", "cover");
      });
      $(elTarget.cTarget).text(Math.round(response.main.temp - 273.15) + "\u00b0C");
      $(elTarget.cminTarget).text(Math.round(response.main.temp_min - 273.15) + "\u00b0C");
      $(elTarget.cmaxTarget).text(Math.round(response.main.temp_max - 273.15) + "\u00b0C");
      $(elTarget.fTarget).text(Math.round(1.8 * (response.main.temp - 273.15) + 32) + "\u00b0F");
      $(elTarget.fminTarget).text(Math.round(1.8 * (response.main.temp_min - 273.15) + 32) + "\u00b0F");
      $(elTarget.fmaxTarget).text(Math.round(1.8 * (response.main.temp_min - 273.15) + 32) + "\u00b0F");
      $(elTarget.descriptionTarget).text(response.weather[0].description);
      $(elTarget.weatherMainTarget).text(response.weather[0].main);
      $(elTarget.lonTarget).text(response.coord.lon);
      $(elTarget.latTarget).text(response.coord.lat);
      $(elTarget.placeTarget).text(response.name + ", " + response.sys.country);
      $(elTarget.windSpeedTarget).text(Math.round(response.wind.speed) + " Mps");
      $(elTarget.humidityTarget).text(response.main.humidity + "%");
      $(elTarget.pressureTarget).text(response.main.pressure + "hPa");
      $(elTarget.sunriseTarget).text(formatTime(response.sys.sunrise) + " AM");
      $(elTarget.sunsetTarget).text(formatTime(response.sys.sunset) + " PM");
      r = response.weather[0].icon;
      $(elTarget.oriIconTarget).attr("src", "//openweathermap.org/img/w/" + r + ".png");
      $(elTarget.customIconTarget).addClass("customIcon-" + r);
      -1 != r.indexOf("d") ? ($(elTarget.owfontTarget).addClass("owf owf-" + response.weather[0].id + "-d"), $(elTarget.bgImageTarget).addClass("bgImage-" + response.weather[0].id + "-d")) : -1 != r.indexOf("n") ? ($(elTarget.owfontTarget).addClass("owf owf-" + response.weather[0].id + "-n"), $(elTarget.bgImageTarget).addClass("bgImage-" + response.weather[0].id + "-n")) : ($(elTarget.owfontTarget).addClass("owf owf-" + response.weather[0].id), $(elTarget.bgImageTarget).addClass("bgImage-" + response.weather[0].id));
      elTarget.success.call(this);
    }, error:function($, response, formatTime) {
      elTarget.error.call(this, response);
    }});
  };
})(jQuery);
